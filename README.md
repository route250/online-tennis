# 対戦型テニスゲーム（WebSocket・サーバ権威）

黒基調のUIとテニスコート風のフィールドで遊べる、LAN内対戦用テニスゲームのプロトタイプです。ロビーで相手を選んで対戦を開始できます。サーバがゲーム状態の一次ソース（authoritative）として物理演算と同期配信を行います。

**主な特徴**
- サーバ権威でボール物理・スコア管理（Node.js + ws）
- 招待を受けた側の画面は自分視点へ自動ミラー（常に自分のパドルが下）
- サーブ前はサーバ側のパドルにボールが追随、クリックでサーブ
- サーブ/返球時にパドルの移動方向・速度がボール速度・角度に反映
- 右側にスコアパネル（DOM）を表示（プレイ領域とは分離）
- コートライン（ネット、サービスライン等）は見た目のみ（物理には非影響）

**フィールド寸法**
- キャンバス: 500 x 700 px（縦長）
- パドル: 幅 80px, 高さ 12px（サーバ定義）

---

## 起動方法

依存のインストールとサーバ起動:

```bash
npm install
node server/index.js
# または PORT を変更
# PORT=8080 node server/index.js
```

ブラウザで `http://localhost:3000` を開きます（ポートは `PORT` に合わせてください）。

注: `npm start` は静的サーバ（http-server）用の定義で、WebSocketサーバが含まれません。必ず `node server/index.js` を使用してください。

---

## 操作とルール

- 操作: マウス（またはタッチ）で自分のパドルを左右にドラッグ
- サーブ: サーブ側プレイヤーのみ、キャンバスクリックで開始（サーブ前はボールが自パドルに追随）
- 得点: ボールが相手側エンドラインを越えると1点。点を取った側が次のサーブ権
- 勝利条件: 先取7点・2点差（最大11点で決着）
- 表示: 右のスコアパネルに自分/相手のスコア、サーブ権（黄色ドット）

---

## 実装メモ（要点）

- サーバ（`server/index.js`）
  - 20Hz で物理更新（壁反射、パドル衝突、スコア判定）
  - 衝突はボール半径考慮 + スイープ判定で「すり抜け」抑制
  - 返球時は接触オフセット + パドル速度で角度・速度を調整
  - サーブ時は直前のパドル速度を初速へ反映
  - 得点時は一時停止し、得点者のパドル前にボールを再配置、サーブ権を設定
  - `GAME_STATE` に `serveId`, `scores` を含め配信

- クライアント（`src/app.js`）
  - 招待を受けた側は画面をミラー描画（自分のパドルが常に下）
  - スコアパネルはDOMで描画（キャンバス外）
  - コートラインをキャンバスに装飾描画（見た目のみ）

---

## フォルダ構成

- `index.html` — ロビー＋ゲーム画面。スコアパネルをDOMで配置
- `src/app.js` — クライアントロジック（WebSocket、描画、入力）
- `server/index.js` — サーバ（Express + ws）。ルーム管理とゲームループ
- `spec.md` — 設計概要とメッセージ仕様
- `tickets.md` — 詳細チケット/計画
- `todo.md` — タスク一覧

---

## 既知の注意点

- 係数（反射時の速度補正など）は暫定値のため、調整余地あり
- ブラウザや端末差による入力・描画タイミングの差はあり得ます
- セキュリティ/認証はプロトタイプ水準（LAN前提）
